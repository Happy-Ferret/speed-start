<html>

<head>

	<link rel="icon" type="image/png" href="chrome://sstart/skin/icon.png">
	<link rel="stylesheet" type="text/css" href="chrome://sstart/skin/contextmenu.css">
	<link rel="stylesheet" type="text/css" href="chrome://sstart/skin/sstart-page.css">

</head>

<body>

<ul id="menu" class="contextmenu">
	<li id="menu-add">Add
		<ul>
			<li type="thumbnail">Thumbnail</li>
			<li type="folder">Folder</li>
			<li type="search">Search</li>
		</ul>
	</li>
	<li id="menu-lock">Lock</li>
	<li id="menu-unlock">Unlock</li>
	<li id="menu-props">Properties</li>
	<li id="menu-alignall">AlignThumbnails</li>
	<li id="menu-refresh">RefreshThumbnails</li>
	<li id="menu-rename">Rename</li>
	<li id="menu-properties">Properties</li>
	<li id="menu-refreshone">RefreshThumbnail</li>
	<li id="menu-remove">Remove</li>
	<li id="menu-prefs">Preferences</li>
</ul>

<div id="factory">
	<div id="widget" class="widget">
		<div class="header">
			<div class="icon"></div>
			<div class="title"></div>
			<div class="button remove"></div>
			<div class="button refresh"></div>
			<div class="button properties"></div>
		</div>
		<div class="body"></div>
	</div>

	<a id="thumbnail" class="thumbnail">
		<div class="hlink"></div>
		<div class="throbber"></div>
		<div class="hlinkb"></div>
		<img>
	</a>

	<input id="search" class="search" type="text"/>
</div>

<div id="quickstart" style="display: none;"></div>

<script src="namespace.js"></script>
<script src="utils.js"></script>
<script src="file.js"></script>
<script src="dom.js"></script>
<script src="prefs.js"></script>
<script src="bookmark.js"></script>
<script src="storage.js"></script>
<script src="sstart.js"></script>
<script src="drag.js"></script>
<script src="contextmenu.js"></script>
<script src="widgets/factory.js"></script>
<script src="widgets/widget.js"></script>
<script src="widgets/thumbnail.js"></script>
<script src="widgets/search.js"></script>
<script>
	(function () {
console.time("SStart");
		var Utils = justoff.sstart.Utils
		var File = justoff.sstart.File
		var Prefs = justoff.sstart.Prefs
		var Storage = justoff.sstart.Storage
		var Factory = justoff.sstart.Factory
		var Dom = justoff.sstart.Dom
		var ContextMenu = justoff.sstart.ContextMenu
		var SStart = justoff.sstart.SStart

		var params = Utils.getQueryParams(document.location);
		var storage = new Storage(params.folder);

		document.title = storage.getTitle();
		if (document.title == "" || document.title == "SStart") {
			document.title = SStart.translate("SStart");
		}

		var factory = new Factory(storage);
		var hasWidgets = factory.createWidgets();

		var quickstart = Dom.get("quickstart");
		if (!hasWidgets) {
			quickstart.innerHTML = SStart.translate("quickstart");
			quickstart.style.display = "block";
		}

		var properties = storage.getProperties();
		if (properties) {
			if (properties.background) {
				document.body.style.backgroundColor = properties.background;
			}
			if (properties.headerColor) {
				document.styleSheets[1].cssRules[6].style.background = properties.headerColor;
				document.styleSheets[1].cssRules[4].style.border = "1px solid " + properties.headerColor;
			}
			if (properties.titleColor) {
				document.styleSheets[1].cssRules[11].style.color = properties.titleColor;
			}
		}

		if (SStart.isBackgroundImageSpecified()) {
			document.body.style.backgroundImage = "url(" + File.getDataFileURL("background") + ")";
			Dom.addClass(document.body, 'background-style-' + Prefs.getInt('backgroundStyle'));
		}

		if (!SStart.areDecorationsVisible()) {
			Dom.addClass(document.body, 'no-decorations');
		}

		if (Prefs.getBool("bottomHeader")) {
				Dom.addClass(document.body, 'b-head');
		}

		function updateLockStatus() {
			var s = SStart.isLocked();
			Dom.removeClass(document.body, s ? 'unlock-edits' : 'lock-edits');
			Dom.addClass(document.body, s ? 'lock-edits' : 'unlock-edits');
		}
		
		ContextMenu.enable(document, Dom.get("menu"));

		Dom.get("menu-add").addEventListener("click", function (e) {
			if (SStart.isLocked()) {
				SStart.setLocked(false);
				updateLockStatus();
			}
			if (SStart.isCacheDOM() && document.location == "chrome://sstart/content/sstart.html") {
				var widgets = document.getElementById("widgets");
				widgets.parentNode.removeChild(widgets);
				factory.createWidgets();
			}
			quickstart.style.display = "none";
			factory.createWidget(e.target.type, SStart.alignToGrid(ContextMenu.click.x), SStart.alignToGrid(ContextMenu.click.y));
		}, false);
		Dom.get("menu-prefs").addEventListener("click", function (e) {
			SStart.openPreferences();
		}, false);
		Dom.get("menu-lock").addEventListener("click", function (e) {
			SStart.setLocked(true);
			updateLockStatus();
		}, false);
		Dom.get("menu-unlock").addEventListener("click", function (e) {
			SStart.setLocked(false);
			if (SStart.isCacheDOM() && document.location == "chrome://sstart/content/sstart.html") {
				var widgets = document.getElementById("widgets");
				widgets.parentNode.removeChild(widgets);
				factory.createWidgets();
			}
			updateLockStatus();
		}, false);
		Dom.get("menu-alignall").addEventListener("click", function (e) {
			if (SStart.isCacheDOM() && SStart.isLocked() && document.location == "chrome://sstart/content/sstart.html") {
				var widgets = document.getElementById("widgets");
				widgets.parentNode.removeChild(widgets);
				SStart.setLocked(false);
				factory.createWidgets();
				SStart.setLocked(true);
			}
console.time("align");
			SStart.alignAll();
console.timeEnd("align");
		}, false);
		Dom.get("menu-refresh").addEventListener("click", function (e) {
			if (SStart.isCacheDOM() && SStart.isLocked() && document.location == "chrome://sstart/content/sstart.html") {
				var widgets = document.getElementById("widgets");
				widgets.parentNode.removeChild(widgets);
				SStart.setLocked(false);
				factory.createWidgets();
				SStart.setLocked(true);
			}
			SStart.refreshAll()
		}, false);
		Dom.get("menu-refreshone").addEventListener("click", function (e) {
			if (SStart.isCacheDOM() && SStart.isLocked() && document.location == "chrome://sstart/content/sstart.html") {
				var widgets = document.getElementById("widgets");
				widgets.parentNode.removeChild(widgets);
				SStart.setLocked(false);
				factory.createWidgets();
				SStart.setLocked(true);
			}
			var hoverEl = ContextMenu.click.el;
			var c = document.getElementById(hoverEl.parentNode.parentNode.parentNode.id);
			var r = Dom.child(c, "refresh");
			if (r) {
				r.click()
			}
		}, false);
		Dom.get("menu-properties").addEventListener("click", function (e) {
			if (SStart.isCacheDOM() && SStart.isLocked() && document.location == "chrome://sstart/content/sstart.html") {
				var widgets = document.getElementById("widgets");
				widgets.parentNode.removeChild(widgets);
				SStart.setLocked(false);
				factory.createWidgets();
				SStart.setLocked(true);
			}
			var hoverEl = ContextMenu.click.el;
			if (Dom.hasClass(hoverEl.parentNode.parentNode.parentNode,'widget')) {
				var c = document.getElementById(hoverEl.parentNode.parentNode.parentNode.id);
			} else if (Dom.hasClass(hoverEl.parentNode.parentNode,'widget')) {
				var c = document.getElementById(hoverEl.parentNode.parentNode.id);
			} else {
				console.log("Err!");
				return;
			}
			var r = Dom.child(c, "properties");
			if (r) {
				r.click()
			}
		}, false);
		Dom.get("menu-remove").addEventListener("click", function (e) {
			if (SStart.isCacheDOM() && SStart.isLocked() && document.location == "chrome://sstart/content/sstart.html") {
				var widgets = document.getElementById("widgets");
				widgets.parentNode.removeChild(widgets);
				SStart.setLocked(false);
				factory.createWidgets();
				SStart.setLocked(true);
			}
			var hoverEl = ContextMenu.click.el;
			if (Dom.hasClass(hoverEl.parentNode.parentNode.parentNode,'widget')) {
				var c = document.getElementById(hoverEl.parentNode.parentNode.parentNode.id);
			} else if (Dom.hasClass(hoverEl.parentNode.parentNode,'widget')) {
				var c = document.getElementById(hoverEl.parentNode.parentNode.id);
			} else {
				console.log("Err!");
				return;
			}
			var r = Dom.child(c, "remove");
			if (r) {
				r.click()
			}
		}, false);
		Dom.get("menu-rename").addEventListener("click", function (e) {
			if (SStart.isCacheDOM() && SStart.isLocked() && document.location == "chrome://sstart/content/sstart.html") {
				var widgets = document.getElementById("widgets");
				widgets.parentNode.removeChild(widgets);
				SStart.setLocked(false);
				factory.createWidgets();
				SStart.setLocked(true);
			}
			var hoverEl = ContextMenu.click.el;
			var c = document.getElementById(hoverEl.parentNode.parentNode.parentNode.id);
			var r = Dom.child(c, "title");
			if (r) {
				var event = new MouseEvent('dblclick', {
					'view': window,
					'bubbles': true,
					'cancelable': true
					});
				r.dispatchEvent(event);
			}
		}, false);
		Dom.get("menu-props").addEventListener("click", function (e) {
			var param = { properties: properties };
			var xul = 'properties.xul';
			openDialog(xul, "properties", "chrome,centerscreen,modal,resizable", param);
			if (param.properties) {
				properties = param.properties;
				storage.setProperties(properties);
				if (properties.background) {
					document.body.style.backgroundColor = properties.background;
				}
				if (properties.headerColor) {
					document.styleSheets[1].cssRules[6].style.background = properties.headerColor;
					document.styleSheets[1].cssRules[4].style.border = "1px solid " + properties.headerColor;
				}
				if (properties.titleColor) {
					document.styleSheets[1].cssRules[11].style.color = properties.titleColor;
				}
			}
		}, false);

		document.body.addEventListener("dblclick", function (e) {
			var hoverEl = document.elementFromPoint(e.clientX, e.clientY);
			if (e.clientX == 0 || hoverEl.nodeName.toLowerCase() != "body" && hoverEl.id != "quickstart")
				return;
			SStart.toggleLocked();
			if (SStart.isCacheDOM() && !SStart.isLocked() && document.location == "chrome://sstart/content/sstart.html") {
				var widgets = document.getElementById("widgets");
				widgets.parentNode.removeChild(widgets);
				factory.createWidgets();
			}
			updateLockStatus();
		}, false);

/*
		document.body.addEventListener("click", function (e) {
			if (document.elementFromPoint(e.clientX, e.clientY).nodeName.toLowerCase() == "body") {
				e.preventDefault();
			}
		}, false);
*/
		updateLockStatus();

		// Disable cache for page
		window.onbeforeunload = function () {
		}
console.timeEnd("SStart");
	})();
</script>

</body>

</html>
